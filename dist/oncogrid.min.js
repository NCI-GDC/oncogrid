"use strict";var oncogrid=function(t){var e=this;e.donors=t.donors||[],e.genes=t.genes||[],e.observations=t.observations||[],e.element=t.element||"body",e.heatMap=t.heatMap||!0,e.colorMap=t.colorMap||{missense_variant:"#ff825a",frameshift_variant:"#57dba4",stop_gained:"#af57db",start_lost:"#af57db",stop_lost:"#ffe",initiator_codon_variant:"#af57db"},e.width=t.width,e.height=t.height};oncogrid.prototype.init=function(){var t=this;t.div=d3.select("body").append("div").attr("class","tooltip-oncogrid").style("opacity",0),t.margin={top:10,right:15,bottom:15,left:80},t.numDonors=t.donors.length,t.numGenes=t.genes.length,t.cellWidth=t.width/t.donors.length,t.cellHeight=t.height/t.genes.length,t.x=d3.scale.ordinal().domain(d3.range(t.numDonors)).rangeBands([0,t.width]),t.y=d3.scale.ordinal().domain(d3.range(t.numGenes)).rangeBands([0,t.height]),t.svg=d3.select(t.element).append("svg").attr("width",t.width+t.margin.left+t.margin.right).attr("height",t.height+t.margin.top+t.margin.bottom).style("margin-left",t.margin.left+"px").append("g").attr("transform","translate("+t.margin.left+","+t.margin.top+")"),t.svg.append("rect").attr("class","background").attr("width",t.width).attr("height",t.height),t.row=t.svg.selectAll(".row").data(t.genes).enter().append("g").attr("class","row").attr("transform",function(e,r){return"translate(0,"+t.y(r)+")"}),t.row.append("line").attr("x2",t.width),t.column=t.svg.selectAll(".column").data(t.donors).enter().append("g").attr("class","column").attr("donor",function(t){return t.donorId}).attr("transform",function(e,r){return"translate("+t.x(r)+")rotate(-90)"}),t.column.append("line").attr("x1",-t.width),t.computeGeneScores(),t.computeScores(),t.sortByScores()},oncogrid.prototype.destroy=function(){var t=this;d3.selectAll("svg").remove(),d3.select("#oncogrid-topcharts").select("svg").remove(),delete t.svg,delete t.topSVG},oncogrid.prototype.getDonorIndex=function(t,e){for(var r=0;r<t.length;r++){var n=t[r];if(n.donorId===e)return r}return-1},oncogrid.prototype.defineRowDragBehaviour=function(){var t=this,e=d3.behavior.drag();e.on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}),e.on("drag",function(e){var r=d3.event.dy,n=t.genes.indexOf(e),o=d3.select(this);o.attr("transform",function(){var t=d3.transform(d3.select(this).attr("transform"));return"translate( 0, "+(parseInt(t.translate[1])+r)+")"});var a=d3.transform(d3.select(this).attr("transform")).translate[1];d3.selectAll(".row").each(function(e){var o,i,s=t.genes.indexOf(e);r>0&&s>n?(i=d3.transform(d3.select(this).attr("transform")).translate[1],a>i&&(o=t.genes[n],t.genes[n]=t.genes[s],t.genes[s]=o)):0>r&&n>s&&(i=d3.transform(d3.select(this).attr("transform")).translate[1],i>a&&(o=t.genes[n],t.genes[n]=t.genes[s],t.genes[s]=o))})}),e.on("dragend",function(){t.computeScores(),t.sortByScores(),t.render()});var r=d3.selectAll(".row").call(e);r.on("click",function(){d3.event.defaultPrevented})},oncogrid.prototype.cluster=function(){var t=this;t.computeGeneScores(),t.genesSortbyScores(),t.computeScores(),t.sortByScores(),t.render()},oncogrid.prototype.removeDonors=function(t){for(var e=this,r=[],n=0;n<e.donors.length;n++){var o=e.donors[n];t(o)&&(r.push(o.donorId),d3.selectAll("."+o.donorId+"-cell").remove(),d3.selectAll("."+o.donorId+"-bar").remove(),e.donors.splice(n,1),n--)}for(var a=0;a<e.observations.length;a++){var i=e.observations[a];e.donors.indexOf(i.donorId)>=0&&(e.observations.splice(a,1),a--)}e.x=d3.scale.ordinal().domain(d3.range(e.donors.length)).rangeBands([0,e.width]),e.cellWidth=e.width/e.donors.length,e.column.remove(),e.column=e.svg.selectAll(".column").data(e.donors).enter().append("g").attr("class","column").attr("donor",function(t){return t.donorId}).attr("transform",function(t,r){return"translate("+e.x(r)+")rotate(-90)"}),e.column.append("line").attr("x1",-e.width),d3.selectAll(".sortable-rect").transition().attr("width",e.cellWidth).attr("y",function(t){return e.getY(t)}).attr("x",function(t){return e.x(e.getDonorIndex(e.donors,t.donorId))}),d3.selectAll(".sortable-bar").transition().attr("width",e.cellWidth-2).attr("x",function(t){return e.x(e.getDonorIndex(e.donors,t.donorId))+1})},oncogrid.prototype.removeGenes=function(t){for(var e=this,r=[],n=0;n<e.genes.length;n++){var o=e.genes[n];t(o)&&(r.push(o.id),d3.selectAll("."+o.id+"-cell").remove(),e.genes.splice(n,1),n--)}e.y=d3.scale.ordinal().domain(d3.range(e.genes.length)).rangeBands([0,e.height]),e.cellHeight=e.height/e.genes.length,e.row.remove(),e.row=e.svg.selectAll(".row").data(e.genes).enter().append("g").attr("class","row").attr("transform",function(t,r){return"translate(0,"+e.y(r)+")"}),e.row.append("line").attr("x2",e.width),e.row.append("text").attr("class","gene-label label-text-font").transition().attr("x",-6).attr("y",e.cellHeight/2).attr("dy",".32em").attr("text-anchor","end").text(function(t,r){return e.genes[r].symbol}),e.defineRowDragBehaviour(),d3.selectAll(".sortable-rect").transition().attr("height",function(t){return e.getHeight(t)}).attr("y",function(t){return e.getY(t)}).attr("x",function(t){return e.x(e.getDonorIndex(e.donors,t.donorId))})},oncogrid.prototype.sortDonors=function(t){var e=this;e.donors.sort(t),e.render()},oncogrid.prototype.mutationScore=function(t,e){for(var r=this,n=0;n<r.observations.length;n++){var o=r.observations[n];if(o.donorId===t&&o.gene===e)return 1}return 0},oncogrid.prototype.mutationGeneScore=function(t,e){for(var r=this,n=0,o=0;o<r.observations.length;o++){var a=r.observations[o];a.gene===e&&a.gene===e&&n++}return n},oncogrid.prototype.computeScores=function(){for(var t=this,e=0;e<t.donors.length;e++){var r=t.donors[e];r.score=0;for(var n=0;n<t.genes.length;n++){var o=t.genes[n];r.score+=t.mutationScore(r.donorId,o.id)*Math.pow(2,t.genes.length+1-n)}}},oncogrid.prototype.computeGeneScores=function(){for(var t=this,e=0;e<t.genes.length;e++){var r=t.genes[e];r.score=0;for(var n=0;n<t.donors.length;n++){var o=t.donors[n];r.score+=t.mutationGeneScore(o.donorId,r.id)}}},oncogrid.prototype.sortScore=function(t,e){return t.score<e.score?1:t.score>e.score?-1:0},oncogrid.prototype.sortByScores=function(){var t=this;t.donors.sort(t.sortScore)},oncogrid.prototype.genesSortbyScores=function(){var t=this;t.genes.sort(t.sortScore)},oncogrid.prototype.renderFirst=function(){var t=this;t.row.append("text").attr("class","gene-label label-text-font").transition().attr("x",-6).attr("y",t.cellHeight/2).attr("dy",".32em").attr("text-anchor","end").text(function(e,r){return t.genes[r].symbol}),t.defineRowDragBehaviour(),t.svg.selectAll("svg").data(t.observations).enter().append("rect").on("mouseover",function(e){t.div.transition().duration(200).style("opacity",.9),t.div.html(e.donorId+"<br/>"+e.gene+"<br/>"+e.id).style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(){t.div.transition().duration(500).style("opacity",0)}).on("click",function(t){window.location="/mutations/"+t.id}).transition().attr("class",function(t){return"sortable-rect "+t.donorId+"-cell "+t.gene+"-cell"}).attr("cons",function(t){return t.consequence}).attr("x",function(e){return t.x(t.getDonorIndex(t.donors,e.donorId))}).attr("y",function(e){return t.getY(e)}).attr("width",t.cellWidth).attr("height",function(e){return t.getHeight(e)}).attr("fill",function(e){return t.getColor(e)}).attr("opacity",function(e){return t.getOpacity(e)}).attr("stroke-width",2),t.renderAgeHistogram()},oncogrid.prototype.renderAgeHistogram=function(){var t=this;(void 0===t.topSVG||null===t.topSVG)&&(t.topSVG=d3.select("#oncogrid-topcharts").append("svg").attr("width",t.width+t.margin.left+t.margin.right).attr("height",100).style("margin-left",t.margin.left+"px").append("g").attr("transform","translate("+t.margin.left+","+t.margin.top+")")),t.topSVG.selectAll("rect").data(t.donors).enter().append("rect").on("mouseover",function(e){t.div.transition().duration(200).style("opacity",.9),t.div.html("Donor: "+e.donorId+"<br/> Age:"+e.age+"<br/>").style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(){t.div.transition().duration(500).style("opacity",0)}).transition().attr("class",function(t){return"sortable-bar "+t.donorId+"-bar"}).attr("width",t.cellWidth-2).attr("height",function(t){return t.age}).attr("x",function(e){return t.x(t.getDonorIndex(t.donors,e.donorId))+1}).attr("y",function(t){return 100-t.age}).attr("fill","#1693C0")},oncogrid.prototype.render=function(){var t=this;d3.selectAll(".row").transition().attr("transform",function(e){return"translate( 0, "+t.y(t.genes.indexOf(e))+")"}),d3.selectAll(".sortable-rect").transition().attr("y",function(e){return t.getY(e)}).attr("x",function(e){return t.x(t.getDonorIndex(t.donors,e.donorId))}),t.topSVG.selectAll("rect").transition().attr("x",function(e){return t.x(t.getDonorIndex(t.donors,e.donorId))+1})},oncogrid.prototype.getY=function(t){var e=this,r=e.genes.map(function(t){return t.id});if(e.heatMap===!0)return e.y(r.indexOf(t.gene));var n=Object.keys(e.colorMap);return e.y(r.indexOf(t.gene))+e.cellHeight/n.length*(n.indexOf(t.consequence)-1)},oncogrid.prototype.getColor=function(t){var e=this;return e.heatMap===!0?"#D33682":e.colorMap[t.consequence]},oncogrid.prototype.getOpacity=function(){var t=this;return t.heatMap===!0?.3:1},oncogrid.prototype.getHeight=function(){var t=this;return t.heatMap===!0?t.cellHeight:t.cellHeight/Object.keys(t.colorMap).length},oncogrid.prototype.toggleHeatmap=function(){var t=this;t.heatMap===!0?t.heatMap=!1:t.heatMap=!0,d3.selectAll(".sortable-rect").transition().attr("y",function(e){return t.getY(e)}).attr("height",function(e){return t.getHeight(e)}).attr("fill",function(e){return t.getColor(e)}).attr("opacity",function(e){return t.getOpacity(e)})};