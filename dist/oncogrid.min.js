"use strict";var oncogrid=function(t){return function(e,n,r,o,a){this.donors=e,this.genes=n,this.observations=r,this.element=o,this.params=a,this.heatMap=!1,this.colorMap={missense_variant:"#ff825a",frameshift_variant:"#57dba4",stop_gained:"#af57db",start_lost:"#af57db",stop_lost:"#ffe",initiator_codon_variant:"#af57db"};var s=this;return this.mutationScore=function(t,e){for(var n=0;n<s.observations.length;n++){var r=s.observations[n];if(r.donorId===t&&r.gene===e)return 1}return 0},this.mutationGeneScore=function(t,e){for(var n=0,r=0;r<s.observations.length;r++){var o=s.observations[r];o.gene===e&&o.gene===e&&n++}return n},this.computeScores=function(){for(var t=0;t<s.donors.length;t++){var e=s.donors[t];e.score=0;for(var n=0;n<s.genes.length;n++){var r=s.genes[n];e.score+=s.mutationScore(e.donorId,r.id)*Math.pow(2,s.genes.length+1-n)}}},this.computeGeneScores=function(){for(var t=0;t<s.genes.length;t++){var e=s.genes[t];e.score=0;for(var n=0;n<s.donors.length;n++){var r=s.donors[n];e.score+=s.mutationGeneScore(r.donorId,e.id)}}},this.sortScore=function(t,e){return t.score<e.score?1:t.score>e.score?-1:0},this.sortByScores=function(){s.donors.sort(s.sortScore)},this.genesSortbyScores=function(){s.genes.sort(s.sortScore)},this.getDonorIndex=function(t,e){for(var n=0;n<t.length;n++){var r=t[n];if(r.donorId===e)return n}return-1},this.init=function(){s.div=t.select("body").append("div").attr("class","tooltip-oncogrid").style("opacity",0),s.margin={top:10,right:15,bottom:15,left:80},s.width=s.params.width,s.height=s.params.height,s.numDonors=s.donors.length,s.numGenes=s.genes.length,s.cellWidth=s.width/s.donors.length,s.cellHeight=s.height/s.genes.length,s.x=t.scale.ordinal().domain(t.range(s.numDonors)).rangeBands([0,s.width]),s.y=t.scale.ordinal().domain(t.range(s.numGenes)).rangeBands([0,s.height]),s.svg=t.select(s.element).append("svg").attr("width",s.width+s.margin.left+s.margin.right).attr("height",s.height+s.margin.top+s.margin.bottom).style("margin-left",s.margin.left+"px").append("g").attr("transform","translate("+s.margin.left+","+s.margin.top+")"),s.svg.append("rect").attr("class","background").attr("width",s.width).attr("height",s.height),s.row=s.svg.selectAll(".row").data(s.genes).enter().append("g").attr("class","row").attr("transform",function(t,e){return"translate(0,"+s.y(e)+")"}),s.row.append("line").attr("x2",s.width),s.column=s.svg.selectAll(".column").data(s.donors).enter().append("g").attr("class","column").attr("donor",function(t){return t.donorId}).attr("transform",function(t,e){return"translate("+s.x(e)+")rotate(-90)"}),s.column.append("line").attr("x1",-s.width),s.computeGeneScores(),s.computeScores(),s.sortByScores()},this.renderFirst=function(){s.row.append("text").attr("class","gene-label label-text-font").transition().attr("x",-6).attr("y",s.cellHeight/2).attr("dy",".32em").attr("text-anchor","end").text(function(t,e){return s.genes[e].symbol}),s.defineRowDragBehaviour(),s.svg.selectAll("svg").data(s.observations).enter().append("rect").on("mouseover",function(e){s.div.transition().duration(200).style("opacity",.9),s.div.html(e.donorId+"<br/>"+e.gene+"<br/>"+e.id).style("left",t.event.pageX+10+"px").style("top",t.event.pageY-28+"px")}).on("mouseout",function(){s.div.transition().duration(500).style("opacity",0)}).on("click",function(t){window.location="/mutations/"+t.id}).transition().attr("class",function(t){return"sortable-rect "+t.donorId+"-cell "+t.gene+"-cell"}).attr("cons",function(t){return t.consequence}).attr("x",function(t){return s.x(s.getDonorIndex(s.donors,t.donorId))}).attr("y",function(t){return s.getY(t)}).attr("width",s.cellWidth).attr("height",function(t){return s.getHeight(t)}).attr("fill",function(t){return s.getColor(t)}).attr("opacity",function(t){return s.getOpacity(t)}).attr("stroke-width",2),s.renderAgeHistogram()},this.renderAgeHistogram=function(){(void 0===s.topSVG||null===s.topSVG)&&(s.topSVG=t.select("#oncogrid-topcharts").append("svg").attr("width",s.width+s.margin.left+s.margin.right).attr("height",100).style("margin-left",s.margin.left+"px").append("g").attr("transform","translate("+s.margin.left+","+s.margin.top+")")),s.topSVG.selectAll("rect").data(s.donors).enter().append("rect").on("mouseover",function(e){s.div.transition().duration(200).style("opacity",.9),s.div.html("Donor: "+e.donorId+"<br/> Age:"+e.age+"<br/>").style("left",t.event.pageX+10+"px").style("top",t.event.pageY-28+"px")}).on("mouseout",function(){s.div.transition().duration(500).style("opacity",0)}).transition().attr("class",function(t){return"sortable-bar "+t.donorId+"-bar"}).attr("width",s.cellWidth-2).attr("height",function(t){return t.age}).attr("x",function(t){return s.x(s.getDonorIndex(s.donors,t.donorId))+1}).attr("y",function(t){return 100-t.age}).attr("fill","#1693C0")},this.defineRowDragBehaviour=function(){var e=t.behavior.drag();e.on("dragstart",function(){t.event.sourceEvent.stopPropagation()}),e.on("drag",function(e){var r=t.event.dy,o=n.indexOf(e),a=t.select(this);a.attr("transform",function(){var e=t.transform(t.select(this).attr("transform"));return"translate( 0, "+(parseInt(e.translate[1])+r)+")"});var s=t.transform(t.select(this).attr("transform")).translate[1];t.selectAll(".row").each(function(e){var a,i,l=n.indexOf(e);r>0&&l>o?(i=t.transform(t.select(this).attr("transform")).translate[1],s>i&&(a=n[o],n[o]=n[l],n[l]=a)):0>r&&o>l&&(i=t.transform(t.select(this).attr("transform")).translate[1],i>s&&(a=n[o],n[o]=n[l],n[l]=a))})}),e.on("dragend",function(){s.computeScores(),s.sortByScores(),s.render()});var r=t.selectAll(".row").call(e);r.on("click",function(){t.event.defaultPrevented})},this.cluster=function(){s.computeGeneScores(),s.genesSortbyScores(),s.computeScores(),s.sortByScores(),s.render()},this.render=function(){t.selectAll(".row").transition().attr("transform",function(t){return"translate( 0, "+s.y(s.genes.indexOf(t))+")"}),t.selectAll(".sortable-rect").transition().attr("y",function(t){return s.getY(t)}).attr("x",function(t){return s.x(s.getDonorIndex(s.donors,t.donorId))}),s.topSVG.selectAll("rect").transition().attr("x",function(t){return s.x(s.getDonorIndex(s.donors,t.donorId))+1})},this.getY=function(t){var e=s.genes.map(function(t){return t.id});if(s.heatMap===!0)return s.y(e.indexOf(t.gene));var n=Object.keys(s.colorMap);return s.y(e.indexOf(t.gene))+s.cellHeight/n.length*(n.indexOf(t.consequence)-1)},this.getColor=function(t){return s.heatMap===!0?"#D33682":s.colorMap[t.consequence]},this.getOpacity=function(){return s.heatMap===!0?.3:1},this.getHeight=function(){return s.heatMap===!0?s.cellHeight:s.cellHeight/Object.keys(s.colorMap).length},this.toggleHeatmap=function(){s.heatMap===!0?s.heatMap=!1:s.heatMap=!0,t.selectAll(".sortable-rect").transition().attr("y",function(t){return s.getY(t)}).attr("height",function(t){return s.getHeight(t)}).attr("fill",function(t){return s.getColor(t)}).attr("opacity",function(t){return s.getOpacity(t)})},this.removeDonors=function(e){for(var n=[],r=0;r<s.donors.length;r++){var o=s.donors[r];e(o)&&(n.push(o.donorId),t.selectAll("."+o.donorId+"-cell").remove(),t.selectAll("."+o.donorId+"-bar").remove(),s.donors.splice(r,1),r--)}for(var a=0;a<s.observations.length;a++){var i=s.observations[a];s.donors.indexOf(i.donorId)>=0&&(s.observations.splice(a,1),a--)}s.x=t.scale.ordinal().domain(t.range(s.donors.length)).rangeBands([0,s.width]),s.cellWidth=s.width/s.donors.length,s.column.remove(),s.column=s.svg.selectAll(".column").data(s.donors).enter().append("g").attr("class","column").attr("donor",function(t){return t.donorId}).attr("transform",function(t,e){return"translate("+s.x(e)+")rotate(-90)"}),s.column.append("line").attr("x1",-s.width),t.selectAll(".sortable-rect").transition().attr("width",s.cellWidth).attr("y",function(t){return s.getY(t)}).attr("x",function(t){return s.x(s.getDonorIndex(s.donors,t.donorId))}),t.selectAll(".sortable-bar").transition().attr("width",s.cellWidth-2).attr("x",function(t){return s.x(s.getDonorIndex(s.donors,t.donorId))+1})},this.removeGenes=function(e){for(var n=[],r=0;r<s.genes.length;r++){var o=s.genes[r];e(o)&&(n.push(o.id),t.selectAll("."+o.id+"-cell").remove(),s.genes.splice(r,1),r--)}s.y=t.scale.ordinal().domain(t.range(s.genes.length)).rangeBands([0,s.height]),s.cellHeight=s.height/s.genes.length,s.row.remove(),s.row=s.svg.selectAll(".row").data(s.genes).enter().append("g").attr("class","row").attr("transform",function(t,e){return"translate(0,"+s.y(e)+")"}),s.row.append("line").attr("x2",s.width),s.row.append("text").attr("class","gene-label label-text-font").transition().attr("x",-6).attr("y",s.cellHeight/2).attr("dy",".32em").attr("text-anchor","end").text(function(t,e){return s.genes[e].symbol}),s.defineRowDragBehaviour(),t.selectAll(".sortable-rect").transition().attr("height",function(t){return s.getHeight(t)}).attr("y",function(t){return s.getY(t)}).attr("x",function(t){return s.x(s.getDonorIndex(s.donors,t.donorId))})},this.sortDonors=function(t){s.donors.sort(t),s.render()},this.destroy=function(){t.selectAll("svg").remove(),t.select("#oncogrid-topcharts").select("svg").remove(),delete s.svg,delete s.topSVG},this}}(d3);